{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}
{% block content %}
<link href="{% static 'css/bootstrap-table.min.css' %}" rel="stylesheet">
<link href="{% static 'css/form.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
<script src="{% static 'js/bootstrap-table.min.js' %}"></script>
<script src="{% static 'js/bootstrap-table-filter-control.min.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/popper.js' %}"></script>
<script type="text/javascript">
	
function show_task_form(){
		var radios = document.getElementsByName('active_labeling');
		const main = document.getElementById("task_details_form")
		const totalTaskForms = document.getElementById("id_form-TOTAL_FORMS")
		for (var radio of radios)
		{
			
			if (radio.checked) {
				if(radio.value != 0){
					document.getElementById("labeling_sensor_list").style.display = "none";
					document.getElementById("task_details_form").style.display = "block";
					const addTaskBtn = document.getElementById("add-task")
                    

					if (radio.value == 3){
						document.getElementById("labeling_sensor_list").style.display = "block";
					}


				}else if(radio.value == 0){
					
					
					const currentTaskForms = document.getElementsByClassName("task-formset mb-4")
					
					if (currentTaskForms.length>1){
						for (count=1 ;count<=currentTaskForms.length;count++){
							const taskFormEl = document.getElementById("form-"+count)
							main.removeChild(taskFormEl)
							
						}
                    }
                    

					totalTaskForms.setAttribute('value',1);
					
					document.getElementById("task_details_form").style.display = "none";
				}
			}
		}
	}

	document.addEventListener('DOMContentLoaded', function() {

	document.getElementById("id_study_label").disabled = true ;
	document.getElementById("id_number_of_subjects").disabled = true ;
    if (document.getElementById('passive_form_checkbox').checked){
		document.getElementById("passive_monitoring_form").style.display = "block";
	}
	var radios = document.getElementsByName('active_labeling');
	
	for (var radio of radios)
  	{
		if (radio.checked && radio.value != 0){
			document.getElementById("labeling_sensor_list").style.display = "none";
			document.getElementById("task_details_form").style.display = "block";
			if (radio.value == 3){
				document.getElementById("labeling_sensor_list").style.display = "block";
			}
		}
	  }
	var selected_list = []
	var options = document.getElementById('id_sensor_list').options;
	for (let i = 0; i < options.length; i++) { 
		if (options[i].selected){
			selected_list.push(options[i].value)
		}
	}

	sensor_list_limited_options = document.getElementById('sensor_list_limited').options
	for (let i=0;i < selected_list.length ; i++){
		
		sensor_list_limited_options.remove(selected_list[i]);
	}
    document.getElementById('id_0_remove_btn').disabled = true    
	}, false);	
	

	
</script>
<div class="row mb-4">
	<ul class="nav nav-tabs">
	<li class="nav-item">
	  <a class="nav-link active" aria-current="page" href="{%url 'home' %}">Studies</a>
	</li>
	{% if request.user|has_group:"Investigator" or request.user|has_group:"administrator" %}
	<li class="nav-item">
	  <a class="nav-link" href="{%url 'survey' %}">Survey</a>
	</li>
	{% endif %}
	<li class="nav-item">
	  <a class="nav-link" href="{%url 'analytics' study_name='all' %}">Analytics</a>
	</li>
  </ul>
</div> 
<div class="row">
	<div class="col-xs-12 col-sm-6">
		<div class="row">
		<div class="col-lg-4">
			<h2>Edit Study</h2></div>
		<div class="col-lg-6">
			
			
		</div>
		
		</div>
		
	</div>
	<div class="col-xs-12 col-sm-9">
			{% if error_message %}
					<p class="text-danger">{{ error_message}}</p>
			{% endif %}

		</div>
</div>

<form action="{%url 'edit_study' study_name=study_name %}" method="POST" enctype="multipart/form-data">
	<div class="row">
		<div class="col-xs-12 col-sm-6" >
		
		{% csrf_token %}
		<div class="form-group required mb-4 ">
			{{study_form.study_label}}
            <label>Study name</label>
			<span><small><i>Please dont use spaces between strings and any special characters</i></small></span>
		</div>
		<div class="row mb-4">
			<div class="col form-group">
				{{study_form.study_duration}}	
                <label>Duration</label>
                <span><small><i>days</i></small></span>
			</div>
			<div class="col form-group">
				{{study_form.number_of_subjects}}
                <label>Number of subjects</label>
                <span><small><i></i></small></span>
			</div>
			<div class="col form-group">
				{{study_form.recording_freq}}
                <label>Recording frequency</label>
			    <span><small><i></i></small></span>
			</div>
		</div>
		
		<div class="row mb-4">
			<div class="col form-group" >
				{{study_form.sensor_list}}
                <label>Passive sensors</label>
				<span><small><i>Please  use ctrl/cmd key for multiple select</i></small></span>
			</div>
		
			<div class="col form-group" >
				{{study_form.sensor_list_limited}}
                <label>Active sensors</label>
				<span><small><i>Please  use ctrl/cmd key for multiple select</i></small></span>
			</div>
		
		</div>

			
			
			
			<div id="task_details_form" >

			{{ task_formset.management_form }}
				<button  id="add-task" type="button" class="btn btn-secondary mb-4" onclick="add_task_form(this.id)"> Add Task</button>

				{% for task_form in task_formset %}
					<div id='form-{{forloop.counter|add:-1 }}' class="task-formset mb-4" >
						<div class="row  mb-4 ">
							<div class="col-sm-4 form-group">
								{{task_form.task_name}}
                                <label>Task name</label>
							</div>
							<div class="col-sm-4">
								<div class="form-group">
									{{task_form.task_preparation}}
                                    <label>Task preparation</label>
											<span><small><i>in seconds</i></small></span>

								</div>
							</div>
							<div class="col-sm-3">
								<div class="form-group">
									{{task_form.task_duration}}
                                    <label>Task duration</label>
											<span><small><i>in seconds</i></small></span>

								</div>
							</div>
							<div class="col-sm-1">
							<a id="id_{{forloop.counter|add:-1}}_remove_btn" type="button" class="btn btn-outline-danger btn-sm " onclick="remove_task_form(this.id)" ><i class="fa fa-trash fa-lg" ></i></a>
							</div>
						</div>

						<div class="row mb-4">
							<div class="form-group">
								{{task_form.task_description}}
                                <label>Task description</label>
										<span><small><i>Text area to describe to task</i></small></span>

							</div>
						</div>


					</div>
					{% endfor %}

			</div>
		<input name="study_label" type="hidden" value="{{study_name}}" />
		<input name="number_of_subjects" type="hidden" value="{{number_of_subjects}}"  />	
		
	</div>
	<div class="col-xs-12 col-sm-4 " style="margin-left: 20px;">
		<div class="form-check mb-4">{{study_form.is_test}} Test Study</div>
		<div class="form-group required mb-4">
			{{study_form.study_description}}
            <label>Study description</label>
		</div>
		{% if is_survey %}
		<div class="form-check mb-4">{{study_form.ema_checkbox}} Ecological momentary assessment <span>
                {% if is_file %}
                    <span>
							<a  href="{%url 'edit_survey' study_name=study_name %}">
							<input type="button" name="edit_survey" value="Edit Survey" type="submit" class="btn btn-primary"  ></a>
							</span>

						{% else %}
                        {{study_form.survey}}
						{% endif %}
        </div>
        <div class="row mb-4">
            <div class=" file-drop-area">
						<span class="choose-file-button">Upload EMA Json file</span>
						<span class="file-message">Drag and drop or Select File</span>
						{{study_form.json_file}}
					</div>

        </div>
        <div class="row mb-4">
					<div class="file-drop-area">
						<span class="choose-file-button">Upload EMA images zip file</span>
						<span class="file-message">Drag and drop or Select File</span>
						{{study_form.images_zip_file}}
						</div>

				</div>
		{% else %}
		<div class="form-check mb-4">{{study_form.ema_checkbox}} Ecological momentary assessment 
			<span  data-toggle="tooltip" data-placement="right" title=' {{info_text.ema}}'>
				<i class="fa fa-question-circle  text-secondary" aria-hidden="true"></i>
			  </span>
		</div>
		<div id="ecological_momentary_form" style="display: none; " >
			<div class="row mb-4">
                    <div class="form-group required mb-4">
						{{study_form.survey}}
                        <label>Survey title</label>
					</div>
				
					<div class="col-sm-9 file-drop-area"> 
						<span class="choose-file-button">Upload EMA Json file</span>
						<span class="file-message">Drag and drop or Select File</span>
						{{study_form.json_file}} 
					</div>
					
				
			</div>
			<div class="row mb-4">
					<div class="file-drop-area"> 
						<span class="choose-file-button">Upload EMA images zip file</span>
						<span class="file-message">Drag and drop or Select File</span>
						{{study_form.images_zip_file}}
						</div>
				
				</div>
			
		</div>
		{% endif %}
		
		

		
	</div>
	</div>	
	<input name="update_study" type="submit" value="Update Study" class="btn btn-primary btn-block mb-8" />
		
	
</form>


{% endblock %}		 
